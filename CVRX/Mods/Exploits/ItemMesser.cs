using ABI.CCK.Components;
using ABI_RC.Core.InteractionSystem;
using ABI_RC.Core.Player;
using BTKUILib;
using CVRX.UIs;
using MelonLoader;
using System.Collections;
using System.Collections.Generic;
using System.Linq;
using UnityEngine;

namespace CVRX.Mods.Exploits
{
    internal class ItemMesser
    {
        public static void Render()
        {
            UIEx.Collapsible("Lobby Lag (Pickup)", () =>
            {
                UIEx.Checkbox(ItemLagBrr, ItemLagBrr ? "Lobby Lag Enabled" : "Lobby Lag Disabled", (newState) =>
                {
                    ItemLagBrr = newState;
                    LobbyLagState(newState);
                });
            });
        }

        public static void ItemCrashState(bool s)
        {
            if (s)
            {
                ItemCrashDir = true;
                MelonCoroutines.Start(ItemCrash(QuickMenuAPI.SelectedPlayerEntity.CVRPlayer));
            }
            else
            {
                ItemCrashDir = false;
            }
        }
        public static void ItemAnnHeadState(bool s)
        {
            if (s)
            {
                ItemHeadAnn = true;
                MelonCoroutines.Start(ItemAnnHead(QuickMenuAPI.SelectedPlayerEntity.CVRPlayer));
            }
            else
            {
                ItemHeadAnn = false;
            }
        }
        #region ItemAnnHead
        public static IEnumerator ItemAnnHead(CVRPlayerEntity P)
        {
            while (ItemHeadAnn)
            {
                using (IEnumerator<CVRPickupObject> enumerator = (IEnumerator<CVRPickupObject>)GameObject.FindObjectsOfType<CVRPickupObject>().GetEnumerator())
                {
                    while (enumerator.MoveNext())
                    {
                        CVRPickupObject vrc_Pickup = enumerator.Current;
                        vrc_Pickup.transform.position = P.PlayerObject.transform.position;
                    }
                    continue;
                }
            }
            yield break;
        }
        #endregion
        public static void TornadoState(bool s)
        {
            if (s)
            {
                MelonCoroutines.Start(Tornado(QuickMenuAPI.SelectedPlayerEntity.PlayerGameObject.transform.position));
            }
            else
            {
                MelonCoroutines.Stop(Tornado(QuickMenuAPI.SelectedPlayerEntity.PlayerGameObject.transform.position));
            }
        }
        #region Tornado
        public static IEnumerator Tornado(Vector3 position)
        {
            var allPickups = GameObject.FindObjectsOfType<CVRPickupObject>().ToList();

            if (allPickups == null || allPickups.Count == 0)
                yield break;

            var relevantPickups = allPickups.Where(p =>
            {
                var name = p.name.ToLower();
                var parentName = p.transform.parent?.name.ToLower() ?? "";
                return !parentName.Contains("eraser") && (name.Contains("pen") || name.Contains("marker") || name.Contains("grip"));
            }).ToList();

            foreach (var pickup in relevantPickups)
            {
                InteractionContext context = new InteractionContext();
                pickup.Drop(context);
                pickup.transform.position = position;
            }

            float radiusA = 0f;
            float radiusB = 0f;
            float heightY = 0.5f;

            const float maxHeight = 5f;
            const float circleSpeed = 20f;
            const int loops = 50;
            const int circleSteps = 95;

            for (int i = 0; i < loops; i++)
            {
                foreach (var pickup in relevantPickups)
                {
                    pickup.transform.rotation = new Quaternion(-0.7f, 0f, 0f, 0.7f);

                    float alpha = 0f;
                    for (int step = 0; step < circleSteps; step++)
                    {
                        alpha += Time.deltaTime * circleSpeed;
                        Vector3 offset = new Vector3(radiusA * Mathf.Cos(alpha), heightY, radiusB * Mathf.Sin(alpha));
                        pickup.transform.position = position + offset;
                        yield return new WaitForSeconds(0.001f);
                    }
                    radiusA += 0.03f;
                    radiusB += 0.03f;
                    if (heightY < maxHeight)
                    {
                        heightY += 0.03f;
                    }
                }
            }
        }
        #endregion
        public static void FancyOrbitState(bool s)
        {
            if (s)
            {
                FOrbitItems = true;
                OrbitTarget = QuickMenuAPI.SelectedPlayerEntity.CVRPlayer;
                MelonCoroutines.Stop(FancyOrbit());
            }
            else
            {
                FOrbitItems = false;
            }
        }
        #region FancyOrbit
        public static IEnumerator FancyOrbit()
        {
            List<CVRPickupObject> AllPickups = GameObject.FindObjectsOfType<CVRPickupObject>().ToList();
            for (; ; )
            {
                try
                {
                    if (!FOrbitItems)
                    {
                        yield break;
                    }
                    GameObject gameObject = new GameObject();
                    gameObject.transform.position = OrbitTarget.PlayerObject.transform.position + new Vector3(0f, 0.35f, 0f);
                    gameObject.transform.Rotate(new Vector3(OrbitAc1, OrbitAc3, OrbitAc1));
                    for (int i = 0; i < AllPickups.Count; i++)
                    {
                        OrbitAc1 += Time.deltaTime / 2f;
                        if (OrbitAc2 <= 3f && Orbit)
                        {
                            OrbitAc2 += Time.deltaTime / 40f;
                        }
                        else if ((double)OrbitAc2 >= 0.1)
                        {
                            OrbitAc2 -= Time.deltaTime / 30f;
                            Orbit = false;
                        }
                        else
                        {
                            Orbit = true;
                        }
                        if (OrbitAc3 <= 50f && Orbittw)
                        {
                            OrbitAc3 += Time.deltaTime * 5f;
                        }
                        else if (OrbitAc2 >= 0.1f)
                        {
                            OrbitAc3 -= Time.deltaTime * 3f;
                            Orbittw = false;
                        }
                        else
                        {
                            Orbittw = true;
                        }
                        AllPickups[i].transform.position = gameObject.transform.position + gameObject.transform.forward * OrbitAc2;
                        AllPickups[i].transform.LookAt(gameObject.transform);
                        gameObject.transform.Rotate(new Vector3(0f, (float)(360 / AllPickups.Count), 0f));
                    }
                    GameObject.Destroy(gameObject);
                }
                catch
                {
                }
                yield return new WaitForSeconds(0.1f);
            }
        }
        #endregion
        public static void LobbyLagState(bool s)
        {
            if (s)
            {
                ItemLagBrr = true;
                MelonCoroutines.Start(LobbyLag());
            }
            else
            {
                ItemLagBrr = false;
            }
        }
        #region LobbyLag
        public static IEnumerator LobbyLag()
        {
            List<CVRPickupObject> AllPickups = GameObject.FindObjectsOfType<CVRPickupObject>()
                .Where(p => !p.gameObject.name.ToLower().Contains("quickmenu"))
                .ToList();

            while (ItemLagBrr)
            {
                int num;
                for (int i = 0; i < 40; i = num + 1)
                {
                    if (!ItemLagBrr)
                    {
                        yield break;
                    }
                    if (AllPickups != null && AllPickups.Count > 5)
                    {
                        if (!ItemLagBrr)
                        {
                            yield break;
                        }
                        foreach (CVRPickupObject Pickup in AllPickups)
                        {
                            if (!ItemLagBrr)
                            {
                                yield break;
                            }
                            if (Pickup.GetComponent<Rigidbody>() != null)
                            {
                                Rigidbody rb = Pickup.GetComponent<Rigidbody>();
                                float bigValue = 2.1474836E+09f;

                                rb.mass = bigValue;
                                rb.useGravity = true;
                                rb.velocity = new Vector3(bigValue, bigValue, bigValue);
                                rb.maxAngularVelocity = bigValue;
                                rb.maxDepenetrationVelocity = bigValue;
                                rb.isKinematic = false;
                                rb.AddForce(new Vector3(bigValue, bigValue, bigValue), (ForceMode)5);
                                rb.AddForce(new Vector3(bigValue, bigValue, bigValue), 0);
                                rb.AddForce(new Vector3(bigValue, bigValue, bigValue), (ForceMode)1);
                                rb.AddForce(new Vector3(bigValue, bigValue, bigValue), (ForceMode)2);
                                rb.angularVelocity = new Vector3(bigValue, bigValue, bigValue);

                                Pickup.throwForceMinVelocity = bigValue;
                                Pickup.throwForceMultiplier = bigValue;
                            }
                            for (int x = 0; x < 2; x = num + 1)
                            {
                                float bigValue = 2.1474836E+09f;
                                Pickup.gameObject.transform.position = new Vector3(bigValue, bigValue, bigValue);
                                Pickup.throwForceMultiplier = 2.1474836E+09f;
                                Pickup.throwForceMinVelocity = 2.1474836E+09f;
                                yield return new WaitForSeconds(0.008f);
                                Pickup.gameObject.transform.position = new Vector3(0f, 0.2f, 0f);
                                num = x;
                            }
                        }
                    }
                    yield return new WaitForSeconds(0.5f);
                    num = i;
                }
            }
        }
        #endregion
        #region ItemCrash
        public static IEnumerator ItemCrash(CVRPlayerEntity p)
        {
            while (ItemCrashDir)
            {
                Vector3 vector = p.PlayerObject.transform.position + new Vector3(0f, 0.1f, 0f);
                try
                {
                    foreach (CVRPickupObject vrcpickup in GameObject.FindObjectsOfType<CVRPickupObject>().ToList())
                    {
                        if (vrcpickup.GetComponent<Rigidbody>() != null)
                        {
                            vrcpickup.GetComponent<Rigidbody>().mass = 2.1474836E+09f;
                            vrcpickup.GetComponent<Rigidbody>().useGravity = true;
                            vrcpickup.GetComponent<Rigidbody>().velocity = new Vector3(2.1474836E+09f, 2.1474836E+09f, 2.1474836E+09f);
                            vrcpickup.GetComponent<Rigidbody>().maxAngularVelocity = 2.1474836E+09f;
                            vrcpickup.GetComponent<Rigidbody>().maxDepenetrationVelocity = 2.1474836E+09f;
                            vrcpickup.GetComponent<Rigidbody>().isKinematic = false;
                            vrcpickup.GetComponent<Rigidbody>().AddForce(new Vector3(2.1474836E+09f, 2.1474836E+09f, 2.1474836E+09f), (ForceMode)5);
                            vrcpickup.GetComponent<Rigidbody>().AddForce(new Vector3(2.1474836E+09f, 2.1474836E+09f, 2.1474836E+09f), 0);
                            vrcpickup.GetComponent<Rigidbody>().AddForce(new Vector3(2.1474836E+09f, 2.1474836E+09f, 2.1474836E+09f), (ForceMode)1);
                            vrcpickup.GetComponent<Rigidbody>().AddForce(new Vector3(2.1474836E+09f, 2.1474836E+09f, 2.1474836E+09f), (ForceMode)2);
                            vrcpickup.GetComponent<Rigidbody>().angularVelocity = new Vector3(2.1474836E+09f, 2.1474836E+09f, 2.1474836E+09f);
                            vrcpickup.throwForceMultiplier = 2.1474836E+09f;
                            vrcpickup.throwForceMinVelocity = 2.1474836E+09f;
                        }
                        if (vrcpickup.GetComponent<Collider>() != null)
                        {
                            vrcpickup.GetComponent<Collider>().enabled = false;
                        }
                        vrcpickup.throwForceMinVelocity = 2.1474836E+09f;
                        vrcpickup.throwForceMultiplier = 2.1474836E+09f;
                    }
                }
                catch
                {
                }
                List<CVRPickupObject> vrc_Pickups = GameObject.FindObjectsOfType<CVRPickupObject>().ToList();
                for (int i = 0; i < vrc_Pickups.Count; i++)
                {
                    ((CVRPickupObject)vrc_Pickups[i]).gameObject.transform.position = vector + new Vector3(0f, 1f, 0f);
                }
                yield return new WaitForSeconds(1f);
            }
            yield break;
        }
        #endregion
        public static void FloorDropper()
        {
            List<CVRPickupObject> list = GameObject.FindObjectsOfType<CVRPickupObject>().ToList();
            for (int i = 0; i < list.Count; i++)
            {
                MelonCoroutines.Start(FreeFallPickup(list[i], 10));
            }
        }
        public static IEnumerator FreeFallPickup(CVRPickupObject Pickup, int HowMuchTime)
        {
            Pickup.GetComponent<Rigidbody>().mass = 2.1474836E+09f;
            Pickup.GetComponent<Rigidbody>().useGravity = true;
            Pickup.GetComponent<Rigidbody>().velocity = new Vector3(2.1474836E+09f, 2.1474836E+09f, 2.1474836E+09f);
            Pickup.GetComponent<Rigidbody>().maxAngularVelocity = 2.1474836E+09f;
            Pickup.GetComponent<Rigidbody>().maxDepenetrationVelocity = 2.1474836E+09f;
            Pickup.GetComponent<Rigidbody>().isKinematic = false;
            Pickup.GetComponent<Rigidbody>().AddForce(new Vector3(2.1474836E+09f, 2.1474836E+09f, 2.1474836E+09f), (ForceMode)5);
            Pickup.GetComponent<Rigidbody>().AddForce(new Vector3(2.1474836E+09f, 2.1474836E+09f, 2.1474836E+09f), 0);
            Pickup.GetComponent<Rigidbody>().AddForce(new Vector3(2.1474836E+09f, 2.1474836E+09f, 2.1474836E+09f), (ForceMode)1);
            Pickup.GetComponent<Rigidbody>().AddForce(new Vector3(2.1474836E+09f, 2.1474836E+09f, 2.1474836E+09f), (ForceMode)2);
            Pickup.GetComponent<Rigidbody>().angularVelocity = new Vector3(2.1474836E+09f, 2.1474836E+09f, 2.1474836E+09f);
            float TimeToStop = Time.time + (float)HowMuchTime;
            while (Time.time < TimeToStop)
            {
                if (!Pickup.name.ToLower().Contains("viewdinder") && !Pickup.name.ToLower().Contains("avatardebugconsole"))
                {
                    Pickup.gameObject.SetActive(true);
                }
                Pickup.gameObject.transform.position = new Vector3(0f, 0f, 0f);
                yield return new WaitForSeconds(1f);
                Pickup.gameObject.transform.position = new Vector3(2.1474836E+09f, 2.1474836E+09f, 2.1474836E+09f);
                yield return new WaitForSeconds(2f);
            }
            Pickup.gameObject.transform.position = new Vector3(0f, 0f, 0f);
            yield break;
        }

        internal static CVRPlayerEntity OrbitTarget;
        internal static bool ItemCrashDir;
        internal static bool ItemHeadAnn;
        internal static bool FOrbitItems;
        internal static bool WhatsAColider;
        internal static bool SpamPrefab;
        internal static bool ItemLagBrr;
        private static float OrbitAc1 = 1f;
        private static float OrbitAc2 = 1f;
        private static float OrbitAc3 = 1f;
        private static bool Orbit = true;
        private static bool Orbittw = true;
    }
}
